<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KÖNIGIN - 十七的房间</title>

  <link rel="stylesheet" href="/style/footer.css">
  <link rel="stylesheet" href="/style/mobile.css">
  <style>
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      margin: 0; 
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: #191919;
      overflow: hidden;
    }

    .app-frame {
      width: 100%;
      height: 100vh;
      max-width: 1440px;
      position: relative;
      margin: 0 auto;
      border-radius: 0;
      overflow: hidden;
      box-shadow: none;
      background: #191919;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0;
      box-sizing: border-box;
    }

    /* 静态背景容器 */
    .static-bg-container {
      position: absolute;
      left: 0; 
      top: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }

    /* 背景图片容器 - 静态显示 */
    .bg-static {
      position: absolute;
      left: 0; 
      top: 0;
      width: 100%;
      height: 100%;
      background-image: url('../../img/guest/17_bg.png');
      background-size: cover; /* 覆盖整个容器 */
      background-position: center center;
      background-repeat: no-repeat;
    }

    /* 内容层 */
    .content-layer {
      position: absolute;
      left: 0; 
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }

    .content-layer > * {
      pointer-events: auto;
    }

    /* 标题 */
    .page-title {
      position: absolute;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 120px;
      z-index: 2;
      pointer-events: none;
    }

    /* 门牌 */
    .guest-title {
      position: absolute;
      top: -3%; 
      left: 50%;
      transform: translateX(-50%);
      width: 750px; 
      height: 300px;
      background: url('../../img/guest/17_door.png') center center/contain no-repeat;
      z-index: 2;
      pointer-events: none;
      opacity: 1; /* 静态显示，始终可见 */
    }

    /* 交互按钮 */
    .interaction-btn {
      position: absolute;
      z-index: 10;
      display: block;
      cursor: pointer;
      top: 60%; /* 按钮位置，大约75%从顶部 */
      left: 53%; /* 按钮位置，居中 */
      transform: translate(-50%, -50%);
    }

    .interaction-btn img {
      width: 8vw;
      height: 8vw;
      min-width: 60px;
      min-height: 60px;
      max-width: 100px;
      max-height: 100px;
      display: block;
      pointer-events: auto;
      transition: all 0.2s ease;
    }

    .interaction-btn:hover img {
      filter: brightness(1.2);
      transform: scale(1.05);
    }

    .interaction-btn:active img {
      filter: brightness(0.8);
      transform: scale(0.95);
    }

    /* 按钮显示/隐藏控制 */
    .interaction-btn {
      opacity: 1; /* 静态显示，始终可见 */
      visibility: visible;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      pointer-events: auto;
    }

    /* 底部遮罩 */
    .bottom-mask {
      position: absolute;
      left: 0; 
      bottom: 0;
      width: 100%;
      height: 92px;
      background: #191919;
      z-index: 3;
      pointer-events: none;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      /* 移动端背景图优化 */
      .bg-static {
        background-size: cover;
        background-position: center center;
      }
    }

    
        /* 客单滚轮选项区域 */
        .guest-list-wrapper{
      position: absolute;
      left: 53%;
      transform: translateX(-50%);
      width: 180px;
      top: 22%;
      height: 300px;
      z-index: 20;
      display: flex;
      align-items: stretch;
      gap: 12px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .guest-list-wrapper.show {
      opacity: 1;
      visibility: visible;
    }
    
    .guest-list{
      position: relative;
      flex: 1 1 auto;
      height: 100%;
      overflow: hidden;
      -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,0) 0, rgba(0,0,0,1) 36px, rgba(0,0,0,1) calc(100% - 36px), rgba(0,0,0,0) 100%);
      mask-image: linear-gradient(to bottom, rgba(0,0,0,0) 0, rgba(0,0,0,1) 36px, rgba(0,0,0,1) calc(100% - 36px), rgba(0,0,0,0) 100%);
    }
    
    .guest-list-viewport{
      height: 288px;
      overflow: hidden;
      padding-right: 8px;
      position: relative;
    }
    
    .guest-items-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      transition: transform 0.3s ease;
    }
    
    .guest-item{
      height: 36px;
      margin: 16px 0;
      width: 80%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 16px;
      font-family: "SimSun", "宋体", serif; /* 改为宋体 */
      letter-spacing: .5px;
      user-select: none;
      pointer-events: auto; /* 改为可点击 */
      cursor: pointer; /* 添加鼠标指针 */
      background: linear-gradient(180deg, #5a5a5a 0%, #4a4a4a 45%, #414141 100%);
      border: 1px solid #696969;
      border-radius: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -2px 4px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.25);
      transition: all 0.2s ease; /* 添加过渡效果 */
    }
    
    .guest-item:hover {
      background: linear-gradient(180deg, #6a6a6a 0%, #5a5a5a 45%, #515151 100%);
      transform: scale(1.02);
    }
    
    .guest-item:active {
      transform: scale(0.98);
    }
    

    .interaction-btn:active img {
  /* 可选：按下变暗或缩放 */
  filter: brightness(0.8);
  transform: scale(0.92);
}
@keyframes btn-blink {
  0%   { opacity: 1; filter: drop-shadow(0 0 0px #fff6) brightness(1); }
  40%  { opacity: 0.6; filter: drop-shadow(0 0 8px #e6f3ff) brightness(1.3);}
  60%  { opacity: 1; filter: drop-shadow(0 0 16px #b5e2ff) brightness(1.5);}
  100% { opacity: 1; filter: drop-shadow(0 0 0px #fff6) brightness(1); }
}
.interaction-btn.blink img {
  animation: btn-blink 1.2s infinite;
  /* 可选：动画节奏平滑 */
  animation-timing-function: ease-in-out;
}
  </style>
</head>
<body>
  <div class="app-frame">
    <div class="bg-static"></div>
    <div class="guest-title"></div>
    
    <!-- 交互按钮 -->
    <a href="#" class="interaction-btn blink" title="Interaction" id="interactionButton">
      <img src="../../img/default btn.png" alt="Interaction Button"/>
    </a>
      
    <!-- 客单滚轮选项（默认隐藏） -->
    <div class="guest-list-wrapper" id="guestList">
      <div class="guest-list">
        <div class="guest-list-viewport" id="guestViewport">
          <div class="guest-items-container" id="guestItemsContainer">
            <div class="guest-item" data-article="paradise/catalog.html">天堂的彼端</div>
            <div class="guest-item" data-article="seeking/catalog.html">seeking</div>
            <div class="guest-item" data-article="infirmary1.html">医闹（上）</div>
            <div class="guest-item" data-article="infirmary2.html">医闹（下）</div>
            <div class="guest-item" data-article="cage.html">血肉重组</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bottom-mask"></div>
  </div>

  <!-- Footer自动插入点 -->
  <div id="footer-placeholder"></div>
<script src="../../js/mobile-optimization.js"></script>
<script src="../../js/footer.js"></script>
<script>
// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('oatmeal page loaded');
  
  // 检查footer是否加载
  setTimeout(() => {
    const footer = document.querySelector('.bottom-nav');
    if (footer) {
      console.log('Footer loaded successfully');
    } else {
      console.log('Footer not found, checking placeholder');
      const placeholder = document.getElementById('footer-placeholder');
      console.log('Footer placeholder:', placeholder);
    }
  }, 1000);
  
  // 交互按钮点击事件
  const interactionButton = document.getElementById('interactionButton');
  const guestList = document.getElementById('guestList');
  let isGuestListVisible = false;
  
  if (interactionButton) {
    console.log('Interaction button found, adding event listeners');
    // 同时支持点击和触摸
    const handleInteractionClick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Interaction button clicked/touched');
      
      // 切换滚轮选项的显示/隐藏
      if (isGuestListVisible) {
        guestList.classList.remove('show');
        isGuestListVisible = false;
        console.log('Guest list hidden');
      } else {
        guestList.classList.add('show');
        isGuestListVisible = true;
        console.log('Guest list shown');
        // 初始化循环滚动
        initCircularScroll();
      }
    };
    
    // 确保按钮可以接收事件
    interactionButton.style.pointerEvents = 'auto';
    interactionButton.style.zIndex = '20'; // 确保按钮在最上层
    
    interactionButton.addEventListener('click', handleInteractionClick);
    interactionButton.addEventListener('touchend', handleInteractionClick);
    console.log('Interaction button event listeners added');
  } else {
    console.error('Interaction button not found');
  }
  
  // 点击空白收起客单滚轮
  const dismissGuest = (e) => {
    if (!isGuestListVisible) return;
    const clickOnButton = interactionButton && interactionButton.contains(e.target);
    const clickOnPanel = guestList && guestList.contains(e.target);
    if (!clickOnButton && !clickOnPanel) {
      isGuestListVisible = false;
      guestList.classList.remove('show');
    }
  };
  document.addEventListener('click', dismissGuest);
  document.addEventListener('touchend', dismissGuest);
  
  // 保存article层级会话的函数
  function saveArticleHierarchySession() {
    const session = {
      timestamp: Date.now(),
      expiry: Date.now() + (30 * 60 * 1000) // 30分钟过期
    };
    sessionStorage.setItem('article_hierarchy_session', JSON.stringify(session));
    console.log('Article层级会话已保存');
  }
  
  // 滑动检测变量
  let isScrolling = false;
  let scrollTimeout = null;
  let touchStartY = 0;
  let touchEndY = 0;
  let hasScrolled = false;
  
  // 循环滚动相关变量
  let currentIndex = 0;
  let guestItems = [];
  let itemHeight = 68; // 36px height + 16px margin * 2
  let originalItemsCount = 0;
  
  // 初始化循环滚动
  function initCircularScroll() {
    const container = document.getElementById('guestItemsContainer');
    if (!container) return;
    
    guestItems = document.querySelectorAll('.guest-item');
    originalItemsCount = guestItems.length;
    console.log('Found', originalItemsCount, 'original guest items');
    
    if (originalItemsCount === 0) return;
    
    // 复制项目以实现循环效果
    const originalItems = Array.from(guestItems);
    
    // 在开头和结尾各添加一份副本
    originalItems.forEach(item => {
      const clone = item.cloneNode(true);
      container.insertBefore(clone, container.firstChild);
    });
    
    originalItems.forEach(item => {
      const clone = item.cloneNode(true);
      container.appendChild(clone);
    });
    
    // 重新获取所有项目（包括副本）
    guestItems = document.querySelectorAll('.guest-item');
    currentIndex = originalItemsCount; // 从原始项目开始
    
    updateScrollPosition();
    console.log('Circular scroll initialized with', guestItems.length, 'total items');
  }
  
  // 更新滚动位置
  function updateScrollPosition() {
    if (guestItems.length === 0) return;
    
    const offset = -currentIndex * itemHeight;
    const container = document.getElementById('guestItemsContainer');
    if (container) {
      container.style.transform = `translateY(${offset}px)`;
      console.log('Scroll position updated, currentIndex:', currentIndex, 'offset:', offset);
    }
  }
  
  // 向上滚动
  function scrollUp() {
    if (guestItems.length === 0) return;
    
    currentIndex--;
    if (currentIndex < 0) {
      currentIndex = guestItems.length - 1;
    }
    updateScrollPosition();
    setScrollingState();
  }
  
  // 向下滚动
  function scrollDown() {
    if (guestItems.length === 0) return;
    
    currentIndex++;
    if (currentIndex >= guestItems.length) {
      currentIndex = 0;
    }
    updateScrollPosition();
    setScrollingState();
  }

  // 客单项目点击事件处理（使用事件委托处理动态添加的项目）
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('guest-item')) {
      // 检查是否刚刚滑动过
      if (isScrolling || hasScrolled) {
        console.log('Click blocked - scrolling detected');
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      
      console.log('Guest item clicked:', e.target.textContent);
      e.preventDefault();
      e.stopPropagation();
      
      const articleFile = e.target.getAttribute('data-article');
      console.log('Data article attribute:', articleFile);
      
      if (articleFile) {
        console.log('Navigating to article:', articleFile);
        // 保存article层级会话后跳转
        saveArticleHierarchySession();
        
        // 特殊处理paradise/catalog.html和seeking/catalog.html的跳转路径
        if (articleFile === 'paradise/catalog.html') {
          console.log('Redirecting to paradise catalog...');
          // 使用绝对路径确保跳转正确
          window.location.href = '/article/private/paradise/catalog.html';
        } else if (articleFile === 'seeking/catalog.html') {
          console.log('Redirecting to seeking catalog...');
          // 使用绝对路径确保跳转正确
          window.location.href = '/article/private/seeking/catalog.html';
        } else {
          console.log('Redirecting to:', `../../article/private/${articleFile}`);
          window.location.href = `../../article/private/${articleFile}`;
        }
      } else {
        console.log('No article specified for:', e.target.textContent);
        // 可以在这里添加默认行为或提示
      }
    }
  });
  
  // 添加循环滚动控制事件监听器
  const guestViewport = document.getElementById('guestViewport');
  if (guestViewport) {
    // 鼠标滚轮事件
    guestViewport.addEventListener('wheel', function(e) {
      if (!isGuestListVisible) return;
      
      e.preventDefault();
      console.log('Wheel scroll detected, deltaY:', e.deltaY);
      
      if (e.deltaY > 0) {
        scrollDown();
      } else {
        scrollUp();
      }
    });
    
    // 触摸事件
    guestViewport.addEventListener('touchstart', function(e) {
      if (!isGuestListVisible) return;
      
      touchStartY = e.touches[0].clientY;
      hasScrolled = false;
      console.log('Touch start at:', touchStartY);
    });
    
    guestViewport.addEventListener('touchmove', function(e) {
      if (!isGuestListVisible) return;
      
      const currentY = e.touches[0].clientY;
      const deltaY = touchStartY - currentY;
      
      // 如果滑动距离超过阈值，标记为滑动状态
      if (Math.abs(deltaY) > 10) {
        hasScrolled = true;
        console.log('Touch move detected, deltaY:', deltaY);
      }
    });
    
    guestViewport.addEventListener('touchend', function(e) {
      if (!isGuestListVisible) return;
      
      touchEndY = e.changedTouches[0].clientY;
      const deltaY = touchStartY - touchEndY;
      
      console.log('Touch end, deltaY:', deltaY, 'hasScrolled:', hasScrolled);
      
      // 如果检测到滑动，触发循环滚动
      if (hasScrolled && Math.abs(deltaY) > 30) {
        if (deltaY > 0) {
          scrollDown();
        } else {
          scrollUp();
        }
      }
    });
  }
  
  // 设置滑动状态
  function setScrollingState() {
    isScrolling = true;
    hasScrolled = true;
    
    // 清除之前的定时器
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    
    // 设置滑动结束定时器
    scrollTimeout = setTimeout(() => {
      isScrolling = false;
      console.log('Scrolling stopped, click events enabled');
    }, 200); // 200ms后允许点击
  }
  
  // 初始化页面元素检查
  console.log('=== Page Elements Check ===');
  console.log('bgStatic:', document.querySelector('.bg-static') ? 'Found' : 'Not found');
  console.log('interactionButton:', interactionButton ? 'Found' : 'Not found');
  console.log('========================');
});
</script>
</body>
</html>

